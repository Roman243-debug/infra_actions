name: Django-app workflow

on: [push]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: 3.7

    - name: Install dependencies
      run: | 
        python -m pip install --upgrade pip 
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        pip install -r requirements.txt 
    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        cd infra_project/
        python manage.py test

  build_and_push_to_docker_hub:
      name: Push Docker image to Docker Hub
      runs-on: ubuntu-latest
      needs: tests
      steps:
        - name: Check out the repo
          # Проверка доступности репозитория Docker Hub для workflow
          uses: actions/checkout@v2 
        - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
          uses: docker/setup-buildx-action@v1 
        - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
          uses: docker/login-action@v1 
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}
        - name: Push to Docker Hub
        # Пуш образа в Docker Hub 
          uses: docker/build-push-action@v2 
          with:
            push: true
            tags: romanmikson/gates:latest
  
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: 158.160.64.79
        username: roman_mikson
        key: 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
8KXtVXgj5Zqg/djPD90EZ/zSJLM=
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull romanmikson/gates
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 romanmikson/gates